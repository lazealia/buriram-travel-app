<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= appName %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #checkoutModal { display: none; position: fixed; inset: 0; z-index: 3000; background: white; }
        .category-pill.active { background-color: #f97316; color: white; border-color: #f97316; }
    </style>
</head>
<body class="bg-[#F2F9F2] pb-32">

    <header class="bg-orange-500 px-5 pt-8 pb-4 rounded-b-[30px] shadow-lg shadow-orange-100/50 sticky top-0 z-50">
        <div class="flex flex-col gap-3">
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 flex-shrink-0">
                    <div class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center text-white backdrop-blur-md border border-white/30">
                        <i class="fa-solid fa-basket-shopping text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black text-white leading-none tracking-tight">ตลาดชุมชน</h1>
                        <p class="text-[9px] text-orange-100 font-medium uppercase tracking-tighter mt-1">Buriram Best Selection</p>
                    </div>
                </div>
                <div class="flex-1 bg-white/10 backdrop-blur-md rounded-xl p-1 flex items-center border border-white/20">
                    <div class="w-7 h-7 flex items-center justify-center text-orange-100">
                        <i class="fa-solid fa-magnifying-glass text-[10px]"></i>
                    </div>
                    <input type="text" id="productSearch" onkeyup="filterProducts()" placeholder="ค้นหาของดีบุรีรัมย์..." class="flex-1 bg-transparent border-none focus:ring-0 text-xs text-white placeholder:text-orange-100/60 py-1">
                </div>
            </div>
        </div>
    </header>

    <div class="px-4 mt-6 mb-2 flex space-x-2 overflow-x-auto no-scrollbar">
        <button onclick="filterCategory('ทั้งหมด')" class="category-pill active whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs font-bold text-orange-600 bg-white transition-all">ทั้งหมด</button>
        <button onclick="filterCategory('ของกิน')" class="category-pill whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs font-bold text-orange-600 bg-white transition-all">ของกิน</button>
        <button onclick="filterCategory('ผ้าไหม')" class="category-pill whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs font-bold text-orange-600 bg-white transition-all">ผ้าไหม</button>
        <button onclick="filterCategory('สมุนไพร')" class="category-pill whitespace-nowrap px-5 py-2 rounded-full border border-orange-200 text-xs font-bold text-orange-600 bg-white transition-all">สมุนไพร</button>
    </div>

    <main id="productGrid" class="p-4 grid grid-cols-2 gap-4">
        <% if (products && products.length > 0) { %>
            <% products.forEach(function(item) { 
                const groupName = item.serviceGroup?.GroupName || '';
                let category = 'ของใช้';
                if (groupName.includes('ผ้า')) category = 'ผ้าไหม';
                else if (groupName.includes('ผลไม้') || groupName.includes('บริโภค') || groupName.includes('อาหารถิ่น')) category = 'ของกิน';
                else if (groupName.includes('สมุนไพร')) category = 'สมุนไพร';

                const bookingUrl = item.serviceOrder?.BookingLink || item.serviceOrder?.OrderLink || '';
            %>
                <div onclick="handleProductClick('<%= bookingUrl %>')" 
                     data-name="<%= item.serviceName.toLowerCase() %>"
                     data-category="<%= category %>"
                     class="product-card bg-white rounded-[30px] shadow-sm border border-orange-50 overflow-hidden flex flex-col active:scale-95 transition-all cursor-pointer group">
                    
                    <div class="h-40 relative overflow-hidden bg-gray-100">
                        <img src="<%= item.serviceImage %>" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/300x300?text=Buriram+Product'">
                        <div class="absolute top-2 right-2">
                            <div class="bg-white/90 backdrop-blur-md px-2 py-1 rounded-lg flex items-center justify-center text-orange-500 shadow-sm text-[8px] font-bold">
                                <%= groupName %>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 flex-grow flex flex-col">
                        <h3 class="text-sm font-bold text-gray-800 line-clamp-1"><%= item.serviceName %></h3>
                        <p class="text-[9px] text-gray-400 mt-1 line-clamp-2 flex-grow leading-relaxed">
                            เจ้าของ: <%= item.serviceContact?.OwnerName || 'ชุมชนบุรีรัมย์' %>
                        </p>
                        
                        <div class="mt-3 flex justify-between items-center bg-orange-50/50 p-2 rounded-2xl">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-orange-400 font-bold leading-none uppercase italic">Price</span>
                                <span class="text-base font-black text-orange-600">฿<%= item.servicePrice %></span>
                            </div>
                            <div class="bg-orange-500 text-white w-7 h-7 rounded-xl flex items-center justify-center shadow-md">
                                <i class="fa-solid fa-cart-shopping text-[10px]"></i>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } %>
        
        <div id="noResults" class="hidden col-span-2 py-20 text-center text-gray-400">
            <i class="fa-solid fa-magnifying-glass-minus text-5xl mb-4 text-orange-200"></i>
            <p class="font-bold text-sm">ไม่พบสินค้าที่คุณต้องการจ้า</p>
        </div>
    </main>

    <div id="checkoutModal">
        <div class="bg-white border-b p-4 flex items-center sticky top-0 z-10 shadow-sm">
            <button onclick="closeCheckout()" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-orange-50 text-orange-600 active:bg-orange-100">
                <i class="fa-solid fa-chevron-left text-lg"></i>
            </button>
            <span class="ml-4 font-bold text-gray-800">จองสินค้าออนไลน์</span>
            <div class="ml-auto flex items-center text-orange-500">
                <i class="fa-solid fa-shield-check mr-1 text-xs"></i>
                <span class="text-[10px] font-bold">Secure</span>
            </div>
        </div>
        <iframe id="checkoutFrame" src="" class="w-full h-[calc(100%-72px)] border-none"></iframe>
    </div>

    <%- include('partials/nav') %>

    <script>
        function filterProducts() {
            const query = document.getElementById('productSearch').value.toLowerCase();
            const cards = document.getElementsByClassName('product-card');
            const noResults = document.getElementById('noResults');
            let found = false;

            Array.from(cards).forEach(card => {
                const name = card.getAttribute('data-name');
                if (name.includes(query)) {
                    card.style.display = "flex";
                    found = true;
                } else {
                    card.style.display = "none";
                }
            });
            noResults.style.display = found ? "none" : "block";
        }

        function filterCategory(category) {
            const cards = document.getElementsByClassName('product-card');
            const pills = document.getElementsByClassName('category-pill');
            const noResults = document.getElementById('noResults');
            let found = false;

            Array.from(pills).forEach(pill => {
                if (pill.innerText === category) pill.classList.add('active');
                else pill.classList.remove('active');
            });

            Array.from(cards).forEach(card => {
                const cardCat = card.getAttribute('data-category');
                if (category === 'ทั้งหมด' || cardCat === category) {
                    card.style.display = "flex";
                    found = true;
                } else {
                    card.style.display = "none";
                }
            });
            noResults.style.display = found ? "none" : "block";
        }

        function handleProductClick(url) {
            if (!url || url === 'null' || url === '') {
                alert('ขออภัยจ้า สินค้านี้ยังไม่เปิดระบบจองออนไลน์\nกรุณาติดต่อผู้ขายโดยตรงจ้า');
                return;
            }
            const modal = document.getElementById('checkoutModal');
            const frame = document.getElementById('checkoutFrame');
            frame.src = url;
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeCheckout() {
            const modal = document.getElementById('checkoutModal');
            document.getElementById('checkoutFrame').src = ''; 
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>