<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= appName %> | ตลาดชุมชน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #fcfcfd; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .category-pill.active { background-color: #ea580c; color: white; border-color: #ea580c; }
        .product-card { transition: transform 0.2s ease; cursor: pointer; }
    </style>
</head>
<body class="pb-24">

    <header class="bg-orange-500 px-5 pt-8 pb-4 rounded-b-[30px] shadow-lg shadow-orange-100/50 sticky top-0 z-50">
        <div class="flex flex-col gap-3">
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 flex-shrink-0">
                    <div class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center text-white backdrop-blur-md border border-white/30">
                        <i class="fa-solid fa-basket-shopping text-sm"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black text-white leading-none tracking-tight">ตลาดชุมชน</h1>
                        <p class="text-[9px] text-orange-100 font-medium uppercase tracking-tighter mt-1">Buriram Best Selection</p>
                    </div>
                </div>
                <form action="/shop" method="GET" class="flex-1 bg-white/10 backdrop-blur-md rounded-xl p-1 flex items-center border border-white/20">
                    <div class="w-7 h-7 flex items-center justify-center text-orange-100">
                        <i class="fa-solid fa-magnifying-glass text-[10px]"></i>
                    </div>
                    <input type="hidden" name="category" value="<%= pagination.category %>">
                    <input type="text" name="search" value="<%= pagination.search %>"
                        placeholder="ค้นหาของดี..." 
                        class="flex-1 bg-transparent border-none focus:ring-0 text-xs text-white placeholder:text-orange-100/60 py-1 outline-none">
                </form>
            </div>
        </div>
    </header>

    <div class="px-4 mt-6 mb-2 flex space-x-2 overflow-x-auto no-scrollbar py-2">
        <% ['ทั้งหมด', 'ของกิน', 'ผลไม้', 'ของใช้', 'ผ้าไหม', 'สุขภาพ'].forEach((cat) => { %>
            <a href="/shop?category=<%= cat %>&search=<%= pagination.search %>" 
                class="category-pill <%= pagination.category === cat ? 'active' : '' %> whitespace-nowrap px-6 py-2 rounded-full border border-orange-200 text-xs font-bold text-orange-600 bg-white shadow-sm transition-all">
                <% if(cat === 'ของกิน') { %> ของกิน
                <% } else if(cat === 'ผลไม้') { %> ผลไม้
                <% } else if(cat === 'ของใช้') { %> ของใช้
                <% } else if(cat === 'สุขภาพ') { %> สุขภาพ
                <% } else { %> <%= cat %> <% } %>
            </a>
        <% }); %>
    </div>

    <main id="productGrid" class="p-4 grid grid-cols-2 gap-4">
        <% products.forEach(function(item) { 
            let actionUrl = '#'; 
            let btnText = 'สอบถาม';
            let btnClass = 'bg-slate-500';
            let btnIcon = 'fa-comment-dots';

            const oLink = (item.serviceOrder?.OrderLink || '').trim();
            const bLink = (item.serviceOrder?.BookingLink || '').trim();
            const bStatus = item.serviceOrder?.BookingStatus;
            
            const tel = (item.serviceContact?.Telephone || '').trim();
            const line = (item.serviceContact?.Line || '').trim();

            if (oLink && !oLink.toLowerCase().startsWith('xxx')) {
                actionUrl = oLink;
                btnText = 'ซื้อเลย'; btnClass = 'bg-green-600'; btnIcon = 'fa-cart-shopping';
            } else if (bLink && !bLink.toLowerCase().startsWith('xxx') && bStatus === 'on') {
                actionUrl = bLink;
                btnText = 'จองสินค้า'; btnClass = 'bg-orange-500'; btnIcon = 'fa-calendar-check';
            } else if (line && line !== '-' && line !== 'ไม่ได้ระบุ' && line !== '') {
                actionUrl = `https://line.me/ti/p/~${line}`;
                btnText = 'คุยไลน์'; btnClass = 'bg-green-500'; btnIcon = 'fa-brands fa-line';
            } else if (tel && tel !== '-' && tel !== 'ไม่ได้ระบุ' && tel !== '') {
                actionUrl = `tel:${tel}`;
                btnText = 'โทรสอบถาม'; btnClass = 'bg-blue-600'; btnIcon = 'fa-solid fa-phone';
            }
        %>
            <div class="product-card bg-white rounded-[30px] shadow-sm border border-orange-50 overflow-hidden flex flex-col active:scale-95 transition-all"
                 onclick="if('<%= actionUrl %>' !== '#') window.open('<%= actionUrl %>', '_blank')">
                
                <div class="h-44 relative overflow-hidden bg-gray-50">
                    <img src="<%= item.serviceImage %>" class="w-full h-full object-cover" loading="lazy">
                </div>

                <div class="p-3 flex-grow flex flex-col">
                    <h3 class="text-[13px] font-bold text-gray-800 line-clamp-1 mb-0.5"><%= item.serviceName %></h3>
                    <div class="flex items-center gap-1 mb-3 text-gray-400">
                        <i class="fa-solid fa-store text-[9px] text-orange-400"></i>
                        <span class="text-[10px] line-clamp-1 font-medium"><%= item.serviceContact?.OwnerName || 'ร้านค้า' %></span>
                    </div>
                    
                    <div class="mt-auto flex items-center justify-between">
                        <p class="text-sm font-black text-orange-600">
                            <%= item.servicePrice > 0 ? '฿' + item.servicePrice : 'สอบถาม' %>
                        </p>
                        <div class="<%= btnClass %> text-white px-2 py-1.5 rounded-xl flex items-center gap-1 shadow-md">
                            <i class="fa-solid <%= btnIcon %> text-[10px]"></i>
                            <span class="text-[9px] font-bold text-nowrap"><%= btnText %></span>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>
    </main>

    <% if (pagination.total > 1) { %>
        <div class="flex justify-center items-center gap-4 py-8">
            <% if (pagination.hasPrev) { %>
                <a href="/shop?page=<%= pagination.current - 1 %>&search=<%= pagination.search %>&category=<%= pagination.category %>" 
                   class="p-3 bg-white border border-orange-100 rounded-xl shadow-sm text-orange-600"><i class="fa-solid fa-chevron-left"></i></a>
            <% } %>
            <span class="text-xs font-bold text-gray-500 uppercase">หน้า <%= pagination.current %> / <%= pagination.total %></span>
            <% if (pagination.hasNext) { %>
                <a href="/shop?page=<%= pagination.current + 1 %>&search=<%= pagination.search %>&category=<%= pagination.category %>" 
                   class="p-3 bg-white border border-orange-100 rounded-xl shadow-sm text-orange-600"><i class="fa-solid fa-chevron-right"></i></a>
            <% } %>
        </div>
    <% } %>

    <%- include('partials/nav') %>

</body>
</html>