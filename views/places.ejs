<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สถานที่ท่องเที่ยว - Buriram Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        #map { height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Marker Styling */
        .custom-div-icon { background: none; border: none; }
        .marker-pin { 
            width: 45px; height: 45px; border-radius: 15px; 
            border: 3px solid white; box-shadow: 0 8px 15px rgba(0,0,0,0.2); 
            overflow: hidden; background: white; cursor: pointer;
        }
        .marker-pin img { width: 100%; height: 100%; object-fit: cover; }
        
        .user-dot { width: 18px; height: 18px; background: #4F46E5; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); }
        
        /* แก้ไขให้ Popup ของ Leaflet ดูเข้ากับ UI */
        .leaflet-popup-content-wrapper { border-radius: 20px; font-family: 'Kanit'; }
        .leaflet-popup-tip-container { display: none; }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden">

    <header class="fixed top-0 left-0 right-0 bg-indigo-600 px-5 pt-8 pb-4 rounded-b-[30px] shadow-lg z-[1001]">
        <div class="flex items-center gap-3">
            <a href="/services" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-lg text-white backdrop-blur-sm active:scale-90 transition-transform">
                <i class="fa-solid fa-chevron-left text-sm"></i>
            </a>
            <div class="flex-shrink-0">
                <h1 class="text-base font-black text-white leading-none tracking-tight">สถานที่เที่ยว</h1>
                <p class="text-[9px] text-indigo-200 font-medium uppercase mt-1">Travel Places</p>
            </div>
            <div class="flex-1 bg-white/10 backdrop-blur-md rounded-xl p-1 flex items-center border border-white/20 ml-2">
                <div class="w-7 h-7 flex items-center justify-center text-indigo-100">
                    <i class="fa-solid fa-magnifying-glass text-[10px]"></i>
                </div>
                <input type="text" id="searchInput" onkeyup="filterPlaces()" 
                       placeholder="ค้นหา..." 
                       class="flex-1 bg-transparent border-none focus:ring-0 text-xs text-white placeholder:text-indigo-200/60 py-1">
            </div>
        </div>
    </header>

    <div id="map"></div>

    <button onclick="findMyLocation()" class="fixed right-4 top-28 z-[1001] bg-white w-12 h-12 rounded-2xl shadow-xl flex items-center justify-center text-indigo-600 active:scale-90 transition-transform border border-gray-100">
        <i class="fa-solid fa-location-crosshairs text-xl"></i>
    </button>

    <div class="fixed bottom-0 left-0 right-0 z-[1000] pointer-events-none pb-28">
        <div class="p-6 pointer-events-auto bg-gradient-to-t from-black/40 to-transparent">
            <div id="placesList" class="flex space-x-4 overflow-x-auto no-scrollbar py-2">
                <% if (typeof places !== 'undefined' && places.length > 0) { %>
                    <% places.forEach(function(place) { %>
                        <div class="place-card min-w-[280px] bg-white rounded-[35px] p-3 shadow-2xl flex items-center space-x-4 cursor-pointer border border-gray-50 active:scale-95 transition-all"
                             data-id="<%= place.id %>"
                             data-name="<%= place.name %>"
                             onclick="goToDetail('<%= place.id %>', '<%= place.coords %>')">
                            <img src="<%= place.img %>" onerror="this.src='https://via.placeholder.com/300'" 
                                 class="w-20 h-20 rounded-[25px] object-cover shadow-sm">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-gray-800 text-sm truncate"><%= place.name %></h3>
                                <p class="text-[10px] text-gray-400 truncate mt-1">
                                    <i class="fa-solid fa-location-dot mr-1 text-red-400"></i><%= place.location %>
                                </p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-full uppercase">
                                        <%= place.price %>
                                    </span>
                                    <i class="fa-solid fa-circle-chevron-right text-indigo-600 text-lg"></i>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('partials/nav', { currentPage: 'services' }) %>

    <script id="places-data" type="application/json"><%- JSON.stringify(places) %></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const places = JSON.parse(document.getElementById('places-data').textContent || "[]");
        var map = L.map('map', { zoomControl: false }).setView([14.993, 103.102], 12);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        var markers = {};
        places.forEach(function(p) {
            if (p.coords && !isNaN(p.coords[0])) {
                // ✅ แก้ไข: เพิ่ม .bindPopup() เพื่อให้หมุดกดได้เหมือนเดิม
                var marker = L.marker(p.coords, {
                    icon: L.divIcon({ 
                        className: 'custom-div-icon', 
                        html: `<div class="marker-pin"><img src="${p.img}"></div>`, 
                        iconSize:[45,45], 
                        iconAnchor:[22,45] 
                    })
                }).addTo(map)
                .bindPopup(`
                    <div style="text-align:center; padding:5px;">
                        <b style="font-size:14px; display:block; margin-bottom:5px;">${p.name}</b>
                        <button onclick="location.href='/detail/${p.id}'" 
                                style="background:#4F46E5; color:white; border:none; padding:5px 15px; border-radius:10px; font-size:12px; cursor:pointer;">
                            ดูข้อมูล
                        </button>
                    </div>
                `);
                markers[p.id] = marker;
            }
        });

        function filterPlaces() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.place-card').forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                const id = card.getAttribute('data-id');
                const isMatch = name.includes(q);
                card.style.display = isMatch ? 'flex' : 'none';
                if(markers[id]) isMatch ? markers[id].addTo(map) : map.removeLayer(markers[id]);
            });
        }

        function goToDetail(id, coords) {
            let target = typeof coords === 'string' ? coords.split(',').map(Number) : coords;
            map.flyTo(target, 16, { animate: true, duration: 1 });
            // เปิด Popup ของหมุดนั้นด้วย
            if(markers[id]) markers[id].openPopup();
            
            // เลื่อน Card มาตรงกลาง
            const card = document.querySelector(`[data-id="${id}"]`);
            card.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }

        function findMyLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                const {latitude, longitude} = pos.coords;
                L.marker([latitude, longitude], { icon: L.divIcon({className:'custom-div-icon', html:'<div class="user-dot"></div>'}) }).addTo(map);
                map.flyTo([latitude, longitude], 15);
            });
        }
    </script>
</body>
</html>